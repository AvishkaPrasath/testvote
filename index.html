<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting System</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js"></script>
</head>
<body>
    <h1>Vote Counter</h1>
    <p>Votes: <span id="voteCount">0</span></p>
    <button id="voteButton">Vote</button>
    <p id="message"></p>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRUzjpMXtsyRl3WP7oYI9UxHLyDOMgq-U",
            authDomain: "myvote-139f7.firebaseapp.com",
            projectId: "myvote-139f7",
            storageBucket: "myvote-139f7.firebasestorage.app",
            messagingSenderId: "495604900067",
            appId: "1:495604900067:web:0f6d73ef25947ed0ba65d6"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const voteButton = document.getElementById('voteButton');
        const voteCount = document.getElementById('voteCount');
        const message = document.getElementById('message');

        // Fetch user's IP address
        async function getIP() {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        }

        // Fetch today's total votes
        async function fetchVoteCount() {
            const today = new Date().toISOString().split('T')[0];
            const docRef = db.collection('dailyVotes').doc(today);
            const doc = await docRef.get();
            if (doc.exists) {
                voteCount.textContent = doc.data().totalVotes;
            } else {
                voteCount.textContent = 0;
            }
        }

        // Handle vote button click
        voteButton.addEventListener('click', async () => {
            try {
                const ip = await getIP();
                const today = new Date().toISOString().split('T')[0];

                // Check if the user has already voted 3 times today
                const userVotes = await db.collection('userVotes')
                    .where('ip', '==', ip)
                    .where('date', '==', today)
                    .get();

                if (userVotes.size >= 3) {
                    message.textContent = 'You have reached the vote limit for today.';
                    return;
                }

                // Record the user's vote
                await db.collection('userVotes').add({
                    ip: ip,
                    date: today,
                    count: 1
                });

                // Update the total votes for the day
                const dailyVoteRef = db.collection('dailyVotes').doc(today);
                const dailyVoteDoc = await dailyVoteRef.get();

                if (dailyVoteDoc.exists) {
                    await dailyVoteRef.update({
                        totalVotes: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    await dailyVoteRef.set({
                        date: today,
                        totalVotes: 1
                    });
                }

                // Update the vote count display
                await fetchVoteCount();
                message.textContent = 'Vote recorded!';
            } catch (error) {
                message.textContent = 'An error occurred. Please try again.';
                console.error(error);
            }
        });

        // Fetch initial vote count
        fetchVoteCount();
    </script>
</body>
</html>
