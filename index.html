<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting System</title>
    <!-- Add Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, getDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRUzjpMXtsyRl3WP7oYI9UxHLyDOMgq-U",
            authDomain: "myvote-139f7.firebaseapp.com",
            projectId: "myvote-139f7",
            storageBucket: "myvote-139f7.firebasestorage.app",
            messagingSenderId: "495604900067",
            appId: "1:495604900067:web:0f6d73ef25947ed0ba65d6",
            measurementId: "G-9W2S4T5YN1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const voteButton = document.getElementById('voteButton');
        const voteCount = document.getElementById('voteCount');
        const message = document.getElementById('message');

        // Fetch user's IP address
        async function getIP() {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
        }

        // Fetch today's total votes
        async function fetchVoteCount() {
            const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format
            const docRef = doc(db, 'dailyVotes', today); // Reference to today's document
            const docSnap = await getDoc(docRef); // Get the document
            if (docSnap.exists()) {
                voteCount.textContent = docSnap.data().totalVotes; // Update the vote count display
            } else {
                voteCount.textContent = 0; // If no votes exist for today, set count to 0
            }
        }

        // Handle vote button click
        voteButton.addEventListener('click', async () => {
            try {
                const ip = await getIP(); // Get the user's IP address
                const today = new Date().toISOString().split('T')[0]; // Get today's date

                // Check if the user has already voted 3 times today
                const userVotesQuery = query(collection(db, 'userVotes'), where('ip', '==', ip), where('date', '==', today));
                const userVotesSnapshot = await getDocs(userVotesQuery);
                if (userVotesSnapshot.size >= 3) {
                    message.textContent = 'You have reached the vote limit for today.';
                    return;
                }

                // Record the user's vote in the userVotes collection
                await addDoc(collection(db, 'userVotes'), {
                    ip: ip,
                    date: today,
                    count: 1
                });

                // Update the total votes for the day in the dailyVotes collection
                const dailyVoteRef = doc(db, 'dailyVotes', today);
                const dailyVoteDoc = await getDoc(dailyVoteRef);
                if (dailyVoteDoc.exists()) {
                    await updateDoc(dailyVoteRef, {
                        totalVotes: increment(1) // Increment the total votes by 1
                    });
                } else {
                    await setDoc(dailyVoteRef, {
                        date: today,
                        totalVotes: 1 // Initialize total votes to 1
                    });
                }

                // Update the vote count display
                await fetchVoteCount();
                message.textContent = 'Vote recorded!';
            } catch (error) {
                message.textContent = 'An error occurred. Please try again.';
                console.error(error);
            }
        });

        // Fetch initial vote count when the page loads
        fetchVoteCount();
    </script>
</head>
<body>
    <h1>Vote Counter</h1>
    <p>Votes: <span id="voteCount">0</span></p>
    <button id="voteButton">Vote</button>
    <p id="message"></p>
</body>
</html>
